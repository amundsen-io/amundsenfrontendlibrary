# Copyright Contributors to the Amundsen project.
# SPDX-License-Identifier: Apache-2.0

import logging

from http import HTTPStatus
from pkg_resources import iter_entry_points

from flask import Response, jsonify, make_response
from flask.blueprints import Blueprint

LOGGER = logging.getLogger(__name__)

# TODO: Blueprint classes might be the way to go
ANNOUNCEMENT_CLIENT_CLASS = None
ANNOUNCEMENT_CLIENT_INSTANCE = None

# get the announcement_client_class from the python entry point
for entry_point in iter_entry_points(group='announcement_client', name='announcement_client_class'):
    announcement_client_class = entry_point.load()
    if announcement_client_class is not None:
        ANNOUNCEMENT_CLIENT_CLASS = announcement_client_class

announcements_blueprint = Blueprint('announcements', __name__, url_prefix='/api/announcements/v0')


@announcements_blueprint.route('/', methods=['GET'])
def get_announcements() -> Response:
    global ANNOUNCEMENT_CLIENT_INSTANCE

    payload = jsonify({"msg":"Success","posts":[{"date":"July 07, 2020","html_content":"hey Amundsen users, we have now indexed all the non-personal schemas in Hive into Amundsen. In the future, it is no longer needed to submit requests for schema indexing.","title":"All the non-personal schemas indexed in Amundsen"},{"date":"June 05, 2020","html_content":"The descriptions for the event tables and its columns in IDL are now available and surfaced in Amundsen (For example <a href=\"https://amundsen.lyft.net/table_detail/gold/hive/default/event_matching_assignment_v2\">default.event_matching_assignment_v2</a> and its <a href=\"https://github.com/lyft/idl/blob/master/protos/pb/events/server/matchingevents/dim_tables_v2_flat.proto#L303\">IDL</a> file ). \n","title":"Event descriptions from IDL are available in Amundsen"},{"date":"May 13, 2020","html_content":"BigQuery tables that are under Rideshare org(fsql-production) are now removed from Amundsen. ","title":"BigQuery tables under Rideshare (fsql-production) removed "},{"date":"May 13, 2020","html_content":"You could now find the <a href=\"https://amundsen.lyft.net/search?resource=table&index=0&filters=%7B%22database%22%3A%7B%22druid%22%3Atrue%7D%7D\"> druid tables  </a> in Amundsen.","title":"Druid DB is indexed in Amundsen"},{"date":"April 01, 2020","html_content":"You could now view the user's title in the Amundsen people page(e.g <a href=\"https://amundsen.lyft.net/user/mgrover@lyft.com\">example page</a>) or when you try searching the user's profile(e.g <a href=\"https://amundsen.lyft.net/search?term=mark%20grover&resource=user&index=0\">example page</a>).","title":"User's title is now available in the Amundsen people page"},{"date":"March 04, 2020","html_content":"As our next step to improve search quality Amundsen now provides a filtering user interface. This feature currently deprecates advanced search syntax, which limited users to only being able to filter by one category and one value at a time. \n<br/><br/>\nWith the new search filtering UI:\n<ol>\n  <li>Users should no longer use advanced search syntax in the search bar -- instead provide your key terms in the search bar and refine your search with filters. Wildcard search (*) can still be used with terms entered in the search bar.</li>\n  <li>Users are not required to enter a search term -- you can navigate directly to the search view by clicking \"Advanced Search >\" where you can execute searches using only filters if desired.</li>\n  <li>Checkboxes support filtering for multiple values within that category.</li>\n  <li>Input boxes only support one value per category. Wildcard search (*) can be used with the terms entered in the filters.</li>\n</ol>\n<br/>\nIn the future we hope to extend this support to include new categories, support entering multiple values across more categories, and iterate through design improvements.","title":"Search Filtering"},{"date":"February 28, 2020","html_content":"Amundsen now has a feature to allow you to create JIRA issues for tables. This is available on the table detail page. Any JIRA tickets containing the table uri will be displayed on this page, and new issues can be created by clicking 'Report an issue' next to 'Request Description'. Issues are created in the DATAHELP project in JIRA. ","title":"JIRA Ticket Integration"},{"date":"November 15, 2019","html_content":"Key highlights: \n<ul>\n  <li>Updated navbar with omni-present search bar</li>\n  <li>New search results layout better utilizes horizontal space</li>\n  <li>New table detail layout, with improved interactions</li>\n  <li>New color theme</li>\n</ul>","title":"Amundsen Redesign"},{"date":"October 23, 2019","html_content":"We've released a couple new interactions in Amundsen which serve as our first step towards improving the engagement of owners with their data resources:\n<ul>\n<li>When an individual is added or removed as on owner from a data resource by anyone other than themselves, they will be notified via email.</li>\n<li>On our table detail page there are two new widgets that will open a form for users to directly request improved metadata from owners. Users can request descriptions for tables that have no description, as well as request improved column descriptions.</li>","title":"Amundsen Notifications"},{"date":"October 03, 2019","html_content":"Amundsen's editable fields now support basic markdown syntax. \n<br/>\nYou can create: <br/>\n# header 1 <br/>\n## header 2<br/>\n### header 3 <br/>\n<i>*italics*</i><br/>\n<strong>**bold**</strong> <br/>\n* bullet points<br/>\nHyperlinks: [display text](url address) <br/>\nSee this guide here: <a href=\"https://www.markdownguide.org/basic-syntax/\" target=\"_blank\">Markdown Guide</a>\n\n","title":"Added Markdown Editing"},{"date":"June 28, 2019","html_content":"Amundsen People feature is now live in production. Now you can search your coworker's name to find their profile and check out which tables they use, bookmark, or own. The family service will also link to the Amundsen profile page.","title":"Amundsen people in prod"},{"date":"June 17, 2019","html_content":"We have added new databases in Amundsen. Now we have indexed the tables in LyftPG postgres and bigquery fannersql project into Amundsen. And we leverage the bigquery and postgres extractors contributed from Amundsen open source community!\n\n<br>\n<br>\nHere is an example for all the postgre tables which are under <a href=\"https://amundsen.lyft.net/search?searchTerm=schema:public&selectedTab=table&pageIndex=0\">public schema</a>; and the bigquery tables are under bigquery database (e.g tables under <a href=\"https://amundsen.lyft.net/search?searchTerm=schema:events&selectedTab=table&pageIndex=0\"> events schema</a>).","title":"New databases added in Amundsen"},{"date":"May 30, 2019","html_content":"<ul>\n<li>Bookmarks - Click on the star icon next to table names to add a or remove a bookmark. Your personal bookmarks will be shown on the homepage (where Popular Tables are).</li>\n<li>Improved Navigation - The search page and URL state is better managed. Clicking the browser \"back\" and \"forward\" arrows should update the search results. Clicking on the Lyft logo or \"AMUNDSEN\" title in the top left will clear out an existing search.</li>\n</ul>","title":"Bookmarks and Navigation"},{"date":"April 30, 2019","html_content":"The \"Last Updated\" timestamp will be shown for all table search results when available. Table Views under the \"pax\" schema are now indexed and searchable (try \"schema:pax\" in the search bar). These tables are labeled as \"Table View\" in the Table Details page.","title":"Last Updated Timestamp and Table Views"},{"date":"February 20, 2019","html_content":"Users can now access the CompilerWorks page of a table directly from Amundsen. They just have to click on the CompilerWorks link in the \u201cTable Lineage\u201d section to open a new page with information on the table lineage, both upstream and downstream, at the table or column level.","title":"CompilerWorks integration"},{"date":"January 25, 2019","html_content":"<li>Amundsen users can now use the \"Explore with SQL\" button to open up Superset SQL Lab in a new tab. SQL Lab will pre-populate fields such as database, schema, title, and a simple query. You can find this button on the table details page just below the \"Data Preview\" button. </li>\n<li>Amundsen users can use the wildcard in advanced search. For instance, you could search with <i>column:*venue*</i>.","title":"New Features"},{"date":"January 15, 2019","html_content":"Previously Amundsen only allows FTE access. With security team's help, Amundsen is now integrated with ACL service. If you are a contractor and needs Amundsen for your work, you could request to add to <b>amundsen-view-ui</b> role for Amundsen in <a href=\"https://tom.lyft.net/request-access\">this link</a> . We will take a look at your request and review it case by case","title":"Amundsen is now integrated with ACL service"},{"date":"December 14, 2018","html_content":"<p>Users now have the ability to add tags to tables, and search for all tables with a particular tag using our advanced search syntax. Please note, when adding a new tag to a table, that table will only be show up in a search for that particular tag after 24hrs</p>\n\n<p>Furthermore, checkout our new <a href='https://amundsen.lyft.net/browse'>Browse Page</a> in the nav bar, where you will be able to see a list of curated tags. Click on a tag to see all of the tables associated with those tags.</p>\n\n<p>Lastly, we have updated our feedback form which is accessible by clicking the bubble on the bottom right. We've provided you with different categories of feedback to choose from, allowing us to triage all of your comments, bug reports, and feature requests with greater efficiency! </p>","title":"Introducing Tags!"},{"date":"December 04, 2018","html_content":"<a href=\"https://confluence.lyft.net/display/ATLAS\"> Atlas </a> no longer updated and deprecated. Please use Amundsen for any analytics question in the future.","title":"Atlas is no longer updated and deprecated. "},{"date":"December 01, 2018","html_content":"Now all the tables generated by rs ETL has source code link as well.","title":"Source Code Available for Redshift ETL Table In Amundsen"},{"date":"November 28, 2018","html_content":"<li>Amundsen now has the same feature parity as atlas which displays source code for those tables generated by hive_etl pipeline.</li>\n<li>Amundsen is now mobile responsive. </li>","title":"Amundsen Displays Source Code for HIVE_ETL Table"},{"date":"November 28, 2018","html_content":"Amundsen passes <a href=\"https://docs.google.com/document/d/1QnGiXtk2Uq_jDslLVF2slCtdRquBjTpaXXRryu-VhBo/edit#heading=h.u8n5umhvcuqz\">production readliness review</a> and is now generally available! We look forward to continue improving this product and serving your data discovery needs. ","title":"Amundsen GA!"},{"date":"November 13, 2018","html_content":"Tired of not finding the right table from search results? Now you could search with the following syntax:\n<ol>\n  <li> <code>schema:$schema_name</code>: This will list all the tables under $schema_name. </li>\n  <li> <code>table:$table_name</code>: This will list the tables with the given name from all the schemas indexed by Amundsen.</li>\n  <li> <code>column:$column_name</code>: This will list all the tables that have the column name. </li>\n</ol>\n\nYou could limit the search results further by searching with an additional query_term as <code>category:$name $query_term</code>(e.g., <code>schema:default ride</code>, <code>table:fact_rides ride</code>, <code>column:route_id ride</code>, etc.)\n","title":"New Advanced Search Syntax Available in Amundsen"},{"date":"November 06, 2018","html_content":"<p>All tables in Amundsen now support description editing! Please help us improve the richness of our metadata by adding and editing table and column descriptions where needed.</p>\n<p>For partitioned tables, we now display the date range for which data is available in that table.</p>\n<p>We no longer require users to be on VPN to access Amundsen. Amundsen is now also accessible when authenticated via Duo.</p>\n<p>Lastly, we encourage all new users to check out our new FAQ linked in the top right. We will update that wiki as needed.</p>\n","title":"Redshift Tables Are Now Editable"},{"date":"October 30, 2018","html_content":"Tables under the following schemas are now available in Amundsen! \ud83c\udf89\n\n<ul>\n<li>basemap</li>\n<li>driver_engagement</li>\n<li>enterprise</li>\n<li>experimentation</li>\n<li>production</li>\n</ul>\n","title":"New Schemas Added"},{"date":"October 01, 2018","html_content":"<p>Presto views were not being indexed correctly in Amundsen. As of September 27th 2018, we have removed Presto views from Amundsen until we scope out a long term solution. See <a href=\"https://superset.lyft.net/superset/sqllab?id=1638\">this Superset query</a> for the full list of views that were removed.</p>","title":"Presto Views Removed"},{"date":"September 11, 2018","html_content":"<p>The search feature has been modified to work with query terms that include a period, underscore, or empty space. For example, you can now search for <code>core.fact_rides</code> or <code>core fact rides</code> or <code>fact_rides</code>. We now also display paginated results to further aid your search.</p>\n\n<p>Curious to know more about the frequent users of a resource? You can now click on a frequent user to get directed to their Family profile.<p>\n\n<p>Curious to know how a table was generated? We now provide a link to the Airflow DAG.<p>\n\n<p>We have updated the formatting of the url for the table detail page. Please make a note to update any links you may have shared with others or posted in any docs.</p>","title":"Search Improvements & New Features"}]}
)
    return make_response(payload, HTTPStatus.OK)

    try:
        if ANNOUNCEMENT_CLIENT_INSTANCE is None and ANNOUNCEMENT_CLIENT_CLASS is not None:
            ANNOUNCEMENT_CLIENT_INSTANCE = ANNOUNCEMENT_CLIENT_CLASS()

        if ANNOUNCEMENT_CLIENT_INSTANCE is None:
            payload = jsonify({'posts': [], 'msg': 'A client for retrieving announcements must be configured'})
            return make_response(payload, HTTPStatus.NOT_IMPLEMENTED)

        return ANNOUNCEMENT_CLIENT_INSTANCE._get_posts()
    except Exception as e:
        message = 'Encountered exception: ' + str(e)
        logging.exception(message)
        payload = jsonify({'posts': [], 'msg': message})
        return make_response(payload, HTTPStatus.INTERNAL_SERVER_ERROR)
